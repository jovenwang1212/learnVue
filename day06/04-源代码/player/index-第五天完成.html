<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Document</title>
  <link rel="stylesheet" href="./css/index.css" />
  <link rel="stylesheet" href="./css/iconfont.css" />
  <link rel="stylesheet" href="./css/results.css" />
  <link rel="stylesheet" href="./css/player.css" />
  <link rel="stylesheet" href="./css/comment.css" />
  <link rel="stylesheet" href="./css/video.css" />
</head>

<body>
  <div id="player">
    <h2 class="title">é»‘äº‘éŸ³ä¹</h2>
    <div class="search">
      <input type="text" @keyup.enter="queryMusic" v-model="keywords" />
      <button @click="queryMusic">
        <span class="iconfont icon-search"></span>
      </button>
    </div>
    <div class="tab-wrapper">
      <!-- tabæ  -->
      <div class="tab-bar">
        <router-link to="/results" class="bar-item">æœç´¢ç»“æœ</router-link>
        <router-link to="/player" class="bar-item">æ­Œæ›²æ’­æ”¾</router-link>
        <router-link to="/video" class="bar-item">mv</router-link>
        <router-link to="/comment" class="bar-item">æ­Œæ›²è¯„è®º</router-link>
      </div>
      <!-- å¯¹åº”çš„å†…å®¹åŒºåŸŸ -->
      <div class="tab-content">
        <router-view></router-view>
      </div>
    </div>
  </div>
  <!-- å¼•å…¥vue.jsè·Ÿvue-router.js -->
  <script src="./lib/vue.js"></script>
  <script src="./lib/vue-router.js"></script>
  <script src="./lib/axios.js"></script>

  <!-- æ­Œæ›²åˆ—è¡¨html -->
  <script type="text/x-template" id="results_tpl">
    <div class="result-wrapper">
          <div class="song" v-for="(item, index) in songList" :key="item.id">
            <div class="name">
              <span class="iconfont icon-play" @click="toPlayer(item.id)"></span>
              <a href="" @click.prevent="toComment(item.id)">{{item.name}}</a>
              <span class="iconfont icon-editmedia" v-show="item.mvid" @click="playMV(item.mvid)"></span>
            </div>
            <div class="singer">{{item.artists|formatSinger}}</div>
            <div class="album">ã€Š{{item.album.name}}ã€‹</div>
            <div class="time">{{item.duration|formatTime}}</div>
          </div>
        </div>
    </script>

  <script type="text/x-template" id="player_tpl">
    <div class="player">
          <div class="left">
            <img class='disc' src="./img/disc.png" alt="">
            <img class='cover' src="./img/cover.png" alt="">
          </div>
          <div class="right">
            <div class="title"><img src="./img/tag.png" alt=""><span>æ”¾ä¸ªå¤§æ‹›ç»™ä½ çœ‹</span> </div>
            <div class="singer">æ­Œæ‰‹: <span>å°¼å¤æ‹‰æ–¯èµµå››</span></div>
            <div class="album">æ‰€å±ä¸“è¾‘: <span>æˆ‘å°±æ˜¯æˆ‘</span></div>
            <audio class='audio' controls :src="musicUrl?musicUrl:''"></audio>
            <ul class='lyric-container'>
              <li class='lyric'>éš¾ä»¥å¿˜è®°</li>
              <li class='lyric'>åˆæ¬¡è§ä½ </li>
              <li class='lyric'>é‚£åŒè¿·äººçš„å°çœ¼ç›</li>
            </ul>
          </div>
        </div>
    </script>

  <script type="text/x-template" id="video_tpl">
    <div class="video" v-if="isInit">
          <div class="title-wrapper">
            <span class='tag'>MV</span>
            <span class='title'>{{mvDetail.name}}</span>
            <span class='artist'>{{mvDetail.artistName}}</span>
          </div>
          <video :src="mvDetail.brs['720']" controls></video>
        </div>
    </script>
  <script type="text/x-template" id="comment_tpl">
    <div class="comment-wrapper">
          <div class="items" v-for="(item, index) in hotComments" :key="item.commentId">
            <div class="item">
              <div class="left">
                <img :src="item.user.avatarUrl" alt="">
              </div>
              <div class="right">
                <div class="top">
                  <span class='user'>{{item.user.nickname}}</span>
                  <span class='content'>{{item.content}}</span>
                </div>
                <div class="bottom">
                  <div class="time">{{item.time|formatTime}}</div>
                  <div class="like-wrapper">
                      <span>ğŸ‘</span>({{item.likedCount}})
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </script>
  <script>
    //  ç»„ä»¶çš„æ³¨å†Œ
    const Results = {
      template: '#results_tpl',
      data() {
        return {
          // æ­Œæ›²æœç´¢ç»“æœåˆ—è¡¨
          songList: []
        }
      },
      // å°½æ—©å‘è¯·æ±‚ï¼Œåˆå§‹åŒ–æ•°æ®
      created() {
        // console.log('mounted')
        axios
          .get(`https://autumnfish.cn/search?keywords=${this.$route.params.keywords}`)
          .then(res => {
            // console.log(res.data.result.songs)
            this.songList = res.data.result.songs
          })
      },
      filters: {
        // æ¯«ç§’æ•°->02:27
        formatTime(msec) {
          // æ€»çš„ç§’æ•°
          let totalSec = msec / 1000
          // åˆ†
          let min = Math.floor(totalSec / 60)

          // å‰©ä½™çš„ç§’
          let sec = Math.floor(totalSec % 60)

          let minStr = min < 10 ? '0' + min : min + ''
          let secStr = sec < 10 ? '0' + sec : sec + ''
          return `${minStr}:${secStr}`
        },
        // å°†æ­Œæ‰‹åå­—ä»¥/æ‹¼åœ¨ä¸€èµ·è¿”å›
        formatSinger(singers) {
          // let str = ''
          // for (let i = 0; i < singers.length; i++) {
          //   str += singers[i].name + '/'
          // }
          // return str.substr(0,str.length-1)
          let arr = []
          for (let i = 0; i < singers.length; i++) {
            arr.push(singers[i].name)
          }
          return arr.join('/')
        }
      },
      methods: {
        // æ˜¾ç¤ºmvç»„ä»¶ï¼Œå¹¶ä¸”ä¼ é€’mvid
        playMV(mvid) {
          // ç¼–ç¨‹å¼å¯¼èˆª
          router.push(`/video/${mvid}`)
        },
        // è·³è½¬åˆ°è¯„è®º,å¹¶ä¼ å‚
        toComment(id) {
          router.push(`/comment/${id}`)
        },
        // è·³è½¬åˆ°æ­Œæ›²æ’­æ”¾,å¹¶ä¼ å‚
        toPlayer(id) {
          router.push(`/player/${id}`)
        }
      },
    }
    const Player = {
      template: '#player_tpl',
      data() {
        return {
          // æ­Œæ›²çš„åœ°å€
          musicUrl: ''
        }
      },
      created() {
        axios.get(`https://autumnfish.cn/song/url?id=${this.$route.params.id}`)
          .then(res => {
            // console.log(res)
            this.musicUrl = res.data.data[0].url
          })
      }
    }
    const Video = {
      template: '#video_tpl',
      data() {
        return {
          // mvçš„åœ°å€
          mvDetail: {},
          //åœ¨æ•°æ®å›æ¥å‰éšè—
          isInit: false
        }
      },
      created() {
        axios.get(`https://autumnfish.cn/mv/detail?mvid=${this.$route.params.mvid}`)
          .then(res => {

            this.mvDetail = res.data.data
            this.isInit = true;
            //  console.log(ret)
            // console.log(this.mvDetail.brs['720'])
          })
      }
    }
    const Comment = {
      template: '#comment_tpl',
      data() {
        return {
          // çƒ­è¯„åˆ—è¡¨
          hotComments: []
        }
      },
      created() {
        axios.get(`https://autumnfish.cn/comment/hot?id=${this.$route.params.id}&type=0`)
          .then(res => {
            this.hotComments = res.data.hotComments
          })
      },
      filters: {
        // 124244431234=> 2017å¹´7æœˆ20æ—¥
        formatTime(time) {
          // å¤„ç†æ•°æ®
          let d = new Date(time)

          // è¿”å›æ•°æ®
          return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`
        }
      }
    }

    const route = [{
        path: '/results/:keywords',
        component: Results
      },
      {
        path: '/player/:id',
        component: Player
      },
      {
        path: '/video/:mvid',
        component: Video
      },
      {
        path: '/comment/:id',
        component: Comment
      }
    ]

    const router = new VueRouter({
      // routes
      routes: route,
      linkActiveClass: 'active'
    })
    const app = new Vue({
      el: '#player',
      router,
      data: {
        keywords: 'åŒ—äº¬æ¬¢è¿ä½ '
      },
      methods: {
        // æ˜¾ç¤ºæœç´¢ç»„ä»¶
        queryMusic() {
          // ç¼–ç¨‹å¼å¯¼èˆªï¼Œåˆ‡åˆ°æœç´¢ç»„ä»¶
          router.push(`/results/${this.keywords}`)
        }
      }
    })
  </script>
</body>

</html>